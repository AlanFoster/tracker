path = request.format.json? ? param_to_dig_path(params[:props_at]) : nil

json.data(dig: path) do

  if Current.user
    json.currentUser do
      json.id Current.user.id
      json.displayName Current.user.display_name
      json.emailAddress Current.user.email_address

      json.signoutForm do
        form_props(url: user_session_path, method: :delete) do |f|
          f.submit 'Sign out'
        end
      end
    end
    json.profilePath edit_user_url
  end

  yield json
end

json.componentIdentifier active_template_virtual_path
json.defers json.deferred!
json.fragments json.fragments!
# json.assets [ asset_path('application.js') ]

if protect_against_forgery?
  json.csrfToken form_authenticity_token
end

if path
  json.action 'graft'
  json.path params[:props_at]
else
  json.action 'savePage'
end

json.restoreStrategy 'fromCacheAndRevisitInBackground'

json.renderedAt Time.now.to_i

json.slices do
  json.flash flash.to_h
end
